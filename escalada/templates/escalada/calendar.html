{% extends 'escalada/layout.html' %}
{% load static %}
{% load tz %}

{% block script %}
    <meta charset='utf-8' />
    <script src="{% static 'fullcalendar/lib/main.js' %}"></script>
    <script>

    document.addEventListener('DOMContentLoaded', function() {
        var lesson_container = document.querySelector('.lesson-container');
        lesson_container.onclick = e => {
            if(e.target === e.currentTarget){
                if (window.getComputedStyle(lesson_container, null).display == 'none'){
                    lesson_container.setAttribute("style", "display: inline;");
                }
                else{
                    lesson_container.setAttribute("style", "display: none;");
                }
            }
        }
        var lesson_info = document.querySelector('.lesson-info');
        var calendarEl = document.getElementById('calendar');
        var navBarWidth = document.querySelector('#navBar').offsetWidth;
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
              left: 'prev,next today',
              center: 'title',
              right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            selectable: true,
            events: [
                {% for lesson in myLessons %}
                    {
                        id: {{lesson.id}},
                        title: "Clase de escalada",
                        start: "{{ lesson.class_date | date:'Y-m-d'}}T{{lesson.climbClass.begin_time | date:'G:i:s'}}",
                        end: "{{ lesson.class_date | date:'Y-m-d'}}T{{lesson.climbClass.end_time | date:'G:i:s'}}",
                        extendedProps: {
                          climbers: {{lesson.id}}
                        }
                    },
                {% endfor %}
                {% for climb in myClimbs %}
                    {
                        id: {{climb.id}},
                        title: "Escalada libre",
                        start: "{{ climb.date | date:'Y-m-d'}}T{{climb.begin_time | date:'G:i:s'}}",
                        end: "{{ climb.date | date:'Y-m-d'}}T{{climb.end_time | date:'G:i:s'}}",
                    },
                {% endfor %}
            ],
            {% if gymCalendar %}
            eventClick: function(info) {
                    fetch(`/lesson/${info.event.id}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        if (window.getComputedStyle(lesson_container, null).display == 'none'){
                            lesson_container.setAttribute("style", "display: inline;");
                        }
                        else{
                            lesson_container.setAttribute("style", "display: none;");
                        }

                        lesson_info.innerHTML = "<p>Students:</p>"
                        obj = data.climbers;
                        for(var key in obj){
                            if (obj.hasOwnProperty(key)){
                                var value=obj[key];
                                lesson_info.innerHTML += `<p>${value.first_name} ${value.last_name}</p>`;
                            }
                        }
                        
                        //lesson_info.innerHTML = data.begin_time;
                    })
              },
            {% endif %}
            dateClick: function(info) {
                calendar.gotoDate(info.date);
                calendar.changeView('timeGridDay');
            }
            
        });
        calendar.render();
    });

    </script>
{% endblock script %}
{% block body %}
    <div class="lesson-container" style="display: none;">
        <div class="lesson-info">
        </div>
    </div>
    <div id='calendar' class="container">

    </div>
{% endblock body %}